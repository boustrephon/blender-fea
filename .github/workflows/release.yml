name: Create Release

on:
  push:
    branches:
      - main

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Get Blender Addon Version
        id: get_version
        run: |
          # Extract version from __init__.py using Python
          import re
          with open("blenderfea/__init__.py", "r") as f:
              content = f.read()
              match = re.search(r'bl_info\s*=\s*\{[^{]*?\'version\'\s*:\s*\((.*?)\)[^}]*?\}', content, re.DOTALL)
              if match:
                  version_tuple_str = match.group(1)
                  # Clean up the version string
                  version = version_tuple_str.replace(" ", "").replace(",", ".")
                  print(f"::set-output name=version::{version}")
              else:
                  print("::error title=Version Extraction Failed::Could not find version in __init__.py")
                  exit(1)

      - name: Zip Blender Addon
        run: |
          cd blenderfea  # Navigate into the add-on's directory
          zip -r ../blenderfea.zip .  # Zip the contents of the directory
          cd .. # Navigate back to the root

      - name: Create GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.get_version.outputs.version }}
          release_name: Release v${{ steps.get_version.outputs.version }}
          body: |
            See CHANGELOG.md for details.  # Or generate release notes
          draft: false
          prerelease: false

      - name: Upload Blender Addon
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./blenderfea.zip
          asset_name: blenderfea-${{ steps.get_version.outputs.version }}.zip
          asset_content_type: application/zip
          